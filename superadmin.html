<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>MEGA ADMIN - ≈ò√≠zen√≠ provozu</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; background: #2c3e50; color: white; }
        h1, h2 { text-align: center; }
        
        .box { background: #34495e; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        /* Styl pro ovl√°dac√≠ prvky */
        select, input, button { padding: 10px; border-radius: 4px; border: none; font-size: 14px; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; }
        input { color: #333; }
        select { color: #333; width: 100%; margin-bottom: 10px; }

        .btn-login { background-color: #3498db; color: white; width: 100%; }
        .btn-save { background-color: #27ae60; color: white; }
        .btn-gone { background-color: #c0392b; color: white; }
        .btn-restore { background-color: #f39c12; color: #2c3e50; width: 100%; }
        .btn-restore:hover { background-color: #e67e22; }

        .hidden { display: none; }
        
        .vlak-row { 
            background: #2c3e50; 
            padding: 10px; 
            margin-bottom: 8px; 
            border-radius: 4px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border: 1px solid #46627f;
        }

        .deleted-row {
            background: #4a2c2c; /* Naƒçervenal√° barva pro smazan√© */
            border: 1px solid #c0392b;
        }

        .section-title { border-bottom: 2px solid #ecf0f1; padding-bottom: 5px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <h1>‚ö° MEGA ADMIN ‚ö°</h1>

    <div id="login-screen" class="box">
        <h2>P≈ôihl√°≈°en√≠</h2>
        <input type="text" id="username" placeholder="SuperAdmin Jm√©no" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
        <input type="password" id="password" placeholder="Heslo" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
        <button onclick="login()" class="btn-login">Vstoupit do syst√©mu</button>
    </div>

    <div id="admin-screen" class="box hidden">
        <div style="text-align: right;"><button onclick="logout()" style="background:none; color:#bdc3c7; border:1px solid #bdc3c7;">Odhl√°sit</button></div>
        
        <h2 class="section-title">üïπÔ∏è Ovl√°d√°n√≠ stanic</h2>
        <p>Vyber stanici a ovl√°dej ji jako m√≠stn√≠ v√Ωpravƒç√≠:</p>
        <select id="station-select" onchange="loadTrainsForStation()"></select>
        
        <div id="active-trains-list"></div>

        <h2 class="section-title" style="margin-top: 40px;">üóëÔ∏è Odjet√© vlaky (Obnoven√≠)</h2>
        <p>Zde jsou vlaky, kter√© byly oznaƒçeny jako "Odjet√©". Kliknut√≠m je vr√°t√≠≈° zpƒõt.</p>
        <div id="deleted-trains-list"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- ZDE VLO≈Ω SV≈ÆJ CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBK6Nov1Csfxr2O7iE2WZoKNchmGVFdbHg",
            authDomain: "somewherevyhledavac.firebaseapp.com",
            databaseURL: "https://somewherevyhledavac-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "somewherevyhledavac",
            storageBucket: "somewherevyhledavac.firebasestorage.app",
            messagingSenderId: "115280119429",
            appId: "1:115280119429:web:20c50edc0b0bd680e9cbec",
            measurementId: "G-ZW5WT8D9YW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const DOMAIN = "@hra.cz"; 

        // GLOB√ÅLN√ç PROMƒöNN√â
        let allTrainsData = []; // Zde si ulo≈æ√≠me naƒçten√Ω JSON

        window.login = () => {
            const user = document.getElementById('username').value + DOMAIN;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, user, pass).catch(e => alert(e.message));
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const loginSc = document.getElementById('login-screen');
            const adminSc = document.getElementById('admin-screen');

            if (user) {
                loginSc.classList.add('hidden');
                adminSc.classList.remove('hidden');
                initSuperAdmin();
            } else {
                loginSc.classList.remove('hidden');
                adminSc.classList.add('hidden');
            }
        });

        // NAƒåTEN√ç DAT
        async function initSuperAdmin() {
            // 1. Naƒçteme spoje.json
            const cas = new Date().getTime();
            const res = await fetch('spoje.json?v=' + cas);
            allTrainsData = await res.json();

            // 2. Napln√≠me SelectBox v≈°emi stanicemi, kter√© najdeme v JSONu
            const staniceSet = new Set();
            allTrainsData.forEach(vlak => {
                vlak.trasa.forEach(bod => staniceSet.add(bod.stanice));
            });
            
            const select = document.getElementById('station-select');
            select.innerHTML = '<option value="">-- Vyber stanici --</option>';
            staniceSet.forEach(st => {
                select.innerHTML += `<option value="${st}">${st}</option>`;
            });

            // 3. Spust√≠me sledov√°n√≠ smazan√Ωch vlak≈Ø
            watchDeletedTrains();
        }

        // --- ƒå√ÅST 1: OVL√ÅD√ÅN√ç STANIC ---
        window.loadTrainsForStation = async () => {
            const station = document.getElementById('station-select').value;
            const list = document.getElementById('active-trains-list');
            list.innerHTML = "";
            
            if(!station) return;

            for(const t of allTrainsData) {
                const stop = t.trasa.find(s => s.stanice === station);
                if (stop) {
                    // Kontrola, zda u≈æ neodjel
                    const odjelSnap = await get(ref(db, `odjezdy/${station}/${t.id}`));
                    if (odjelSnap.exists() && odjelSnap.val() === true) continue; // Neukazujeme odjet√© tady

                    // Naƒçten√≠ zpo≈ædƒõn√≠
                    const delaySnap = await get(ref(db, `zpozdeni/${station}/${t.id}`));
                    const delay = delaySnap.val() || 0;

                    const div = document.createElement('div');
                    div.className = 'vlak-row';
                    div.id = `row-${t.id}`;
                    div.innerHTML = `
                        <div><strong>${t.nazev}</strong> (${stop.cas})</div>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="d-${t.id}" value="${delay}" style="width:50px">
                            <button class="btn-save" onclick="saveDelay('${station}', '${t.id}')">üíæ</button>
                            <button class="btn-gone" onclick="vlakOdjel('${station}', '${t.id}')">Odjel</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            }
        };

        window.saveDelay = (station, trainId) => {
            const val = document.getElementById(`d-${trainId}`).value;
            set(ref(db, `zpozdeni/${station}/${trainId}`), parseInt(val))
                .then(() => alert("Ulo≈æeno (SuperAdmin)"));
        };

        window.vlakOdjel = (station, trainId) => {
            if(confirm("Poslat vlak do ko≈°e?")) {
                set(ref(db, `odjezdy/${station}/${trainId}`), true)
                    .then(() => loadTrainsForStation()); // P≈ôeƒç√≠st znovu seznam
            }
        };

        // --- ƒå√ÅST 2: OBNOVEN√ç VLAK≈Æ ---
        function watchDeletedTrains() {
            // Sledujeme celou slo≈æku 'odjezdy' v re√°ln√©m ƒçase
            const odjezdyRef = ref(db, 'odjezdy');
            
            onValue(odjezdyRef, (snapshot) => {
                const list = document.getElementById('deleted-trains-list');
                list.innerHTML = "";
                
                if (!snapshot.exists()) {
                    list.innerHTML = "<p style='color:#bdc3c7; text-align:center;'>Ko≈° je pr√°zdn√Ω.</p>";
                    return;
                }

                // Data vypadaj√≠ takto: { "Praha": { "R805": true }, "Brno": { ... } }
                const data = snapshot.val();

                // Projdeme stanice
                Object.keys(data).forEach(stanice => {
                    // Projdeme vlaky v t√© stanici
                    Object.keys(data[stanice]).forEach(vlakId => {
                        
                        // Najdeme jm√©no vlaku pro hezƒç√≠ v√Ωpis
                        const vlakInfo = allTrainsData.find(t => t.id === vlakId);
                        const vlakNazev = vlakInfo ? vlakInfo.nazev : vlakId;

                        const div = document.createElement('div');
                        div.className = 'vlak-row deleted-row';
                        div.innerHTML = `
                            <div>
                                <strong>${vlakNazev}</strong><br>
                                <small>Odjel z: ${stanice}</small>
                            </div>
                            <button class="btn-restore" onclick="obnovitVlak('${stanice}', '${vlakId}')">
                                ‚Ü∫ VR√ÅTIT NA KOLEJ
                            </button>
                        `;
                        list.appendChild(div);
                    });
                });
            });
        }

        window.obnovitVlak = (stanice, vlakId) => {
            if(confirm(`Vr√°tit vlak ${vlakId} zpƒõt do stanice ${stanice}?`)) {
                // Smaz√°n√≠ z√°znamu z 'odjezdy' = vlak se vr√°t√≠
                remove(ref(db, `odjezdy/${stanice}/${vlakId}`))
                    .then(() => alert("Vlak byl obnoven!"));
            }
        };

    </script>
</body>
</html>
