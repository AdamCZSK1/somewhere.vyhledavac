<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Centr√°ln√≠ Dispeƒçink</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #ecf0f1; }
        .box { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h1, h2 { color: #2c3e50; margin-top: 0; }
        
        input, select, button { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; border: none; font-weight: bold; color: white; transition: 0.2s; }
        
        .btn-login { background-color: #3498db; }
        .btn-save { background-color: #27ae60; width: auto; }
        .btn-gone { background-color: #c0392b; width: auto; }
        .btn-logout { background-color: #95a5a6; margin-top: 20px; }
        
        .vlak-row { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .super-panel { border: 2px solid #f39c12; background: #fffdf6; }
    </style>
</head>
<body>

    <h1>üöÜ Centr√°ln√≠ Dispeƒçink</h1>

    <div id="login-screen" class="box">
        <h2>P≈ôihl√°≈°en√≠</h2>
        <input type="text" id="username" placeholder="U≈æivatelsk√© jm√©no (nap≈ô. pepa)">
        <input type="password" id="password" placeholder="Heslo">
        <button onclick="login()" class="btn-login">P≈ôihl√°sit se</button>
        <p style="text-align:center; margin-top:15px;"><a href="index.html">Zpƒõt na vyhled√°vaƒç</a></p>
    </div>

    <div id="superadmin-screen" class="box super-panel hidden">
        <h2>‚ö° SuperAdmin Panel</h2>
        
        <h3>üë• Spr√°va slu≈æeb</h3>
        <div style="display:flex; gap:10px;">
            <input type="text" id="admin-user-name" placeholder="Jm√©no (nap≈ô. pepa)">
            <input type="text" id="admin-station-name" placeholder="Stanice (nap≈ô. Praha)">
        </div>
        <button onclick="priraditSluzbu()" style="background:#8e44ad;">P≈ôi≈ôadit slu≈æbu</button>
        <div id="users-list" style="margin-top:10px; font-size:0.9em; color:#666;"></div>

        <hr style="margin: 20px 0;">

        <h3>üïπÔ∏è Ovl√°d√°n√≠ provozu</h3>
        <select id="station-select" onchange="loadTrainsForSuperAdmin()">
            <option value="">-- Vyber stanici --</option>
        </select>
        <div id="super-trains-list"></div>

        <h3>üóëÔ∏è Ko≈° (Smazan√© vlaky)</h3>
        <div id="deleted-trains-list"></div>
        
        <button onclick="logout()" class="btn-logout">Odhl√°sit se</button>
    </div>

    <div id="normal-screen" class="box hidden">
        <h2>Stanice: <span id="my-station" style="color:#2980b9">...</span></h2>
        <div id="my-trains-list"></div>
        <button onclick="logout()" class="btn-logout">Konec smƒõny</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- ZDE VLO≈Ω SV≈ÆJ CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBK6Nov1Csfxr2O7iE2WZoKNchmGVFdbHg",
            authDomain: "somewherevyhledavac.firebaseapp.com",
            databaseURL: "https://somewherevyhledavac-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "somewherevyhledavac",
            storageBucket: "somewherevyhledavac.firebasestorage.app",
            messagingSenderId: "115280119429",
            appId: "1:115280119429:web:20c50edc0b0bd680e9cbec",
            measurementId: "G-ZW5WT8D9YW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const DOMAIN = "@hra.cz"; 
        let allTrainsData = [];

        window.login = () => {
            const user = document.getElementById('username').value + DOMAIN;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, user, pass).catch(e => alert(e.message));
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            const loginSc = document.getElementById('login-screen');
            const superSc = document.getElementById('superadmin-screen');
            const normalSc = document.getElementById('normal-screen');

            loginSc.classList.add('hidden');
            superSc.classList.add('hidden');
            normalSc.classList.add('hidden');

            if (user) {
                // Naƒçten√≠ dat vlak≈Ø
                const cas = new Date().getTime();
                const res = await fetch('spoje.json?v=' + cas);
                allTrainsData = await res.json();

                // 1. KONTROLA: Je to SuperAdmin? (Pt√°me se datab√°ze)
                const adminRef = ref(db, 'admins/' + user.uid);
                const adminSnap = await get(adminRef);

                if (adminSnap.exists() && adminSnap.val() === true) {
                    // JE TO ADMIN
                    superSc.classList.remove('hidden');
                    initSuperAdmin();
                } else {
                    // JE TO Bƒö≈ΩN√ù U≈ΩIVATEL
                    normalSc.classList.remove('hidden');
                    initNormalAdmin(user);
                }
            } else {
                loginSc.classList.remove('hidden');
            }
        });

        // --- LOGIKA Bƒö≈ΩN√ù V√ùPRAVƒå√ç ---
        async function initNormalAdmin(user) {
            const username = user.email.split('@')[0].toLowerCase();
            // Hled√°me v tabulce slu≈æeb podle jm√©na
            const snap = await get(ref(db, 'sluzby_names/' + username));
            const station = snap.val();
            
            if (!station) {
                document.getElementById('my-station').innerText = "Nem√°≈° p≈ôidƒõlenou stanici!";
                return;
            }
            document.getElementById('my-station').innerText = station;
            renderTrains(station, 'my-trains-list');
        }

        // --- LOGIKA SUPERADMIN ---
        function initSuperAdmin() {
            // Select stanic
            const stations = new Set();
            allTrainsData.forEach(t => t.trasa.forEach(s => stations.add(s.stanice)));
            const sel = document.getElementById('station-select');
            sel.innerHTML = '<option value="">-- Vyber stanici --</option>';
            stations.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);

            loadUsersList();
            watchDeleted();
        }

        window.priraditSluzbu = async () => {
            const name = document.getElementById('admin-user-name').value.trim().toLowerCase();
            const station = document.getElementById('admin-station-name').value.trim();
            if(!name || !station) { alert("Chyba: Vypl≈à jm√©no i stanici."); return; }

            await set(ref(db, 'sluzby_names/' + name), station);
            alert(`OK: ${name} m√° nyn√≠ stanici ${station}`);
            loadUsersList();
        };

        function loadUsersList() {
            onValue(ref(db, 'sluzby_names'), (snap) => {
                const list = document.getElementById('users-list');
                list.innerHTML = "<strong>Aktu√°ln√≠ slu≈æby:</strong><br>";
                if(snap.exists()) {
                    const data = snap.val();
                    Object.keys(data).forEach(k => list.innerHTML += `${k} -> ${data[k]}<br>`);
                }
            });
        }

        // --- SPOLEƒåN√â FUNKCE (Vykreslen√≠) ---
        window.loadTrainsForSuperAdmin = () => {
            const st = document.getElementById('station-select').value;
            if(st) renderTrains(st, 'super-trains-list');
        };

        async function renderTrains(station, elementId) {
            const list = document.getElementById(elementId);
            list.innerHTML = "";

            for(const t of allTrainsData) {
                const stop = t.trasa.find(s => s.stanice === station);
                if(stop) {
                    const odjel = (await get(ref(db, `odjezdy/${station}/${t.id}`))).val();
                    if(odjel) continue;

                    let delay = (await get(ref(db, `zpozdeni/${station}/${t.id}`))).val() || 0;
                    
                    // P≈ô√≠choz√≠ zpo≈ædƒõn√≠
                    let incoming = 0;
                    if(delay === 0) {
                        for(const b of t.trasa) {
                            if(b.stanice === station) break;
                            const d = (await get(ref(db, `zpozdeni/${b.stanice}/${t.id}`))).val();
                            if(d) incoming = d;
                        }
                        delay = incoming;
                    }

                    const div = document.createElement('div');
                    div.className = 'vlak-row';
                    div.innerHTML = `
                        <div>
                            <strong>${t.nazev}</strong> (${stop.cas})
                            ${incoming > 0 ? `<span style='color:orange; font-size:0.8em;'>(veze ${incoming})</span>` : ''}
                        </div>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="d-${elementId}-${t.id}" value="${delay}" style="width:50px">
                            <button class="btn-save" onclick="saveD('${station}','${t.id}','d-${elementId}-${t.id}')">üíæ</button>
                            <button class="btn-gone" onclick="gone('${station}','${t.id}', '${elementId}')">Odjel</button>
                        </div>
                    `;
                    list.appendChild(div);
                }
            }
        }

        window.saveD = (st, id, inputId) => {
            const val = document.getElementById(inputId).value;
            set(ref(db, `zpozdeni/${st}/${id}`), parseInt(val));
        };

        window.gone = (st, id, elId) => {
            if(confirm("Vlak odjel?")) {
                set(ref(db, `odjezdy/${st}/${id}`), true)
                    .then(() => {
                        if(elId === 'super-trains-list') window.loadTrainsForSuperAdmin();
                        else { 
                           const u = auth.currentUser;
                           if(u) initNormalAdmin(u);
                        }
                    });
            }
        };

        function watchDeleted() {
             onValue(ref(db, 'odjezdy'), (snap) => {
                const div = document.getElementById('deleted-trains-list');
                div.innerHTML = "";
                if(snap.exists()) {
                    const data = snap.val();
                    Object.keys(data).forEach(st => {
                        Object.keys(data[st]).forEach(id => {
                           div.innerHTML += `
                            <div style="background:#ffdada; border:1px solid red; padding:5px; margin:5px 0; display:flex; justify-content:space-between;">
                                <span>${id} (${st})</span>
                                <button onclick="restore('${st}','${id}')">Obnovit</button>
                            </div>`; 
                        });
                    });
                }
             });
        }
        window.restore = (st, id) => remove(ref(db, `odjezdy/${st}/${id}`));

    </script>
</body>
</html>
