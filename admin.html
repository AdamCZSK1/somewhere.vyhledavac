<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Centr√°ln√≠ Dispeƒçink v2.0</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #ecf0f1; }
        .box { background: white; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h1, h2, h3 { color: #2c3e50; margin-top: 0; }
        
        input, select, button, textarea { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { cursor: pointer; border: none; font-weight: bold; color: white; transition: 0.2s; }
        
        .btn-login { background-color: #3498db; }
        .btn-add { background-color: #8e44ad; }
        .btn-import { background-color: #f39c12; color: black; }
        .btn-delete { background-color: #c0392b; width: auto; padding: 5px 10px; font-size: 0.8em; float:right; }
        .btn-save { background-color: #27ae60; width: auto; }
        .btn-gone { background-color: #c0392b; width: auto; }
        .btn-logout { background-color: #95a5a6; margin-top: 20px; }
        
        .super-panel { border-left: 5px solid #f39c12; }
        .train-item { background: #f9f9f9; padding: 10px; border-bottom: 1px solid #ddd; }
        .vlak-row { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <h1>üöÜ Centr√°ln√≠ Dispeƒçink</h1>

    <div id="login-screen" class="box">
        <h2>P≈ôihl√°≈°en√≠</h2>
        <input type="text" id="username" placeholder="U≈æivatelsk√© jm√©no (nap≈ô. pepa)">
        <input type="password" id="password" placeholder="Heslo">
        <button onclick="login()" class="btn-login">P≈ôihl√°sit se</button>
        <p style="text-align:center; margin-top:10px;"><a href="index.html">Zpƒõt na web</a></p>
    </div>

    <div id="superadmin-screen" class="box super-panel hidden">
        <h2>‚ö° SuperAdmin - Spr√°va syst√©mu</h2>

        <div style="background: #fff8e1; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <h3>üöÇ Spr√°va J√≠zdn√≠ho ≈ô√°du (Datab√°ze)</h3>
            <button onclick="importFromJSON()" class="btn-import">‚ö†Ô∏è Nahr√°t vlaky ze spoje.json do Datab√°ze (Pou≈æ√≠t 1x)</button>
            <hr>
            <h4>P≈ôidat nov√Ω vlak</h4>
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-id" placeholder="ID (nap≈ô. R900)">
                <input type="text" id="new-name" placeholder="N√°zev (nap≈ô. Rychl√≠k Vysoƒçina)">
            </div>
            <textarea id="new-route" rows="3" placeholder="Trasa (napi≈°: Stanice ƒåas, Stanice ƒåas...)&#10;Nap≈ô: Praha 12:00, Kol√≠n 12:40, Brno 14:50"></textarea>
            <button onclick="pridatVlak()" class="btn-add">P≈ôidat vlak do syst√©mu</button>

            <div id="db-trains-list" style="margin-top:15px; max-height: 200px; overflow-y: auto; border:1px solid #ddd;"></div>
        </div>

        <h3>üë• Spr√°va slu≈æeb</h3>
        <div style="display:flex; gap:10px;">
            <input type="text" id="admin-user-name" placeholder="Jm√©no (nap≈ô. pepa)">
            <input type="text" id="admin-station-name" placeholder="Stanice (nap≈ô. Praha)">
        </div>
        <button onclick="priraditSluzbu()" style="background:#2ecc71;">P≈ôi≈ôadit slu≈æbu</button>
        <div id="users-list" style="font-size: 0.9em; color: #666; margin-top: 5px;"></div>

        <hr>
        <h3>üïπÔ∏è Ovl√°d√°n√≠ zpo≈ædƒõn√≠</h3>
        <select id="station-select" onchange="loadTrainsForSuperAdmin()">
            <option value="">-- Vyber stanici --</option>
        </select>
        <div id="super-trains-list"></div>
        
        <button onclick="logout()" class="btn-logout">Odhl√°sit se</button>
    </div>

    <div id="normal-screen" class="box hidden">
        <h2>Stanice: <span id="my-station" style="color:#2980b9">...</span></h2>
        <div id="my-trains-list"></div>
        <button onclick="logout()" class="btn-logout">Konec smƒõny</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, set, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- TVOJE CONFIGURACE (VLO≈ΩENO) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBK6Nov1Csfxr2O7iE2WZoKNchmGVFdbHg",
            authDomain: "somewherevyhledavac.firebaseapp.com",
            databaseURL: "https://somewherevyhledavac-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "somewherevyhledavac",
            storageBucket: "somewherevyhledavac.firebasestorage.app",
            messagingSenderId: "115280119429",
            appId: "1:115280119429:web:20c50edc0b0bd680e9cbec",
            measurementId: "G-ZW5WT8D9YW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const DOMAIN = "@hra.cz"; 
        
        let allTrainsData = []; 

        window.login = () => {
            const user = document.getElementById('username').value + DOMAIN;
            const pass = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, user, pass).catch(e => alert(e.message));
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('superadmin-screen').classList.add('hidden');
            document.getElementById('normal-screen').classList.add('hidden');

            if (user) {
                // Sledujeme zmƒõny v DB (tabulka 'spoje')
                onValue(ref(db, 'spoje'), (snap) => {
                    if(snap.exists()) {
                        const data = snap.val();
                        allTrainsData = Object.values(data); 
                        renderDbTrainsList(allTrainsData);
                    } else {
                        allTrainsData = [];
                    }
                    checkUserRole(user);
                });
                
                // Naƒçten√≠ seznamu slu≈æeb pro Admina
                onValue(ref(db, 'sluzby_names'), (snap) => {
                    const list = document.getElementById('users-list');
                    list.innerHTML = "";
                    if(snap.exists()) {
                        const data = snap.val();
                        Object.keys(data).forEach(k => list.innerHTML += `${k} -> ${data[k]} | `);
                    }
                });

            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        async function checkUserRole(user) {
            const adminRef = ref(db, 'admins/' + user.uid);
            const adminSnap = await get(adminRef);

            if (adminSnap.exists() && adminSnap.val() === true) {
                document.getElementById('superadmin-screen').classList.remove('hidden');
                initSuperAdmin();
            } else {
                document.getElementById('normal-screen').classList.remove('hidden');
                initNormalAdmin(user);
            }
        }

        // --- P≈òID√ÅV√ÅN√ç VLAK≈Æ ---
        window.importFromJSON = async () => {
            if(!confirm("P≈ôepsat datab√°zi ze souboru spoje.json?")) return;
            try {
                const res = await fetch('spoje.json');
                const data = await res.json();
                for(const vlak of data) {
                    await set(ref(db, 'spoje/' + vlak.id), vlak);
                }
                alert("Hotovo! Vlaky nahr√°ny.");
            } catch(e) { alert("Chyba: " + e); }
        };

        window.pridatVlak = async () => {
            const id = document.getElementById('new-id').value.trim();
            const nazev = document.getElementById('new-name').value.trim();
            const routeRaw = document.getElementById('new-route').value.trim();

            if(!id || !nazev || !routeRaw) { alert("Vypl≈à v≈°e!"); return; }

            const trasa = [];
            const parts = routeRaw.split(',');
            for(const part of parts) {
                const [stanice, cas] = part.trim().split(' ');
                if(stanice && cas) trasa.push({ stanice: stanice, cas: cas });
            }

            if(trasa.length < 2) { alert("Chybn√Ω form√°t trasy!"); return; }

            await set(ref(db, 'spoje/' + id), { id, nazev, trasa });
            alert("Vlak p≈ôid√°n!");
            document.getElementById('new-id').value = "";
            document.getElementById('new-name').value = "";
            document.getElementById('new-route').value = "";
        };

        window.smazatVlakDB = async (vlakId) => {
            if(confirm("Smazat vlak " + vlakId + "?")) await remove(ref(db, 'spoje/' + vlakId));
        };

        function renderDbTrainsList(listData) {
            const list = document.getElementById('db-trains-list');
            list.innerHTML = "";
            listData.forEach(v => {
                list.innerHTML += `
                    <div class="train-item">
                        <b>${v.id}</b> - ${v.nazev}
                        <button class="btn-delete" onclick="smazatVlakDB('${v.id}')">Smazat</button>
                    </div>`;
            });
        }

        // --- LOGIKA DISPEƒåINKU ---
        function initSuperAdmin() {
            const stations = new Set();
            allTrainsData.forEach(t => t.trasa.forEach(s => stations.add(s.stanice)));
            const sel = document.getElementById('station-select');
            sel.innerHTML = '<option value="">-- Vyber stanici --</option>';
            stations.forEach(s => sel.innerHTML += `<option value="${s}">${s}</option>`);
        }

        window.loadTrainsForSuperAdmin = () => {
             const st = document.getElementById('station-select').value;
             if(st) renderTrains(st, 'super-trains-list');
        };

        window.priraditSluzbu = async () => {
             const name = document.getElementById('admin-user-name').value.toLowerCase();
             const st = document.getElementById('admin-station-name').value;
             await set(ref(db, 'sluzby_names/'+name), st);
             alert("Slu≈æba nastavena");
        };

        async function initNormalAdmin(user) {
            const username = user.email.split('@')[0].toLowerCase();
            const snap = await get(ref(db, 'sluzby_names/' + username));
            const station = snap.val();
            if(station) {
                document.getElementById('my-station').innerText = station;
                renderTrains(station, 'my-trains-list');
            } else {
                 document.getElementById('my-station').innerText = "Nem√°≈° stanici";
            }
        }

        async function renderTrains(station, elId) {
             const list = document.getElementById(elId);
             list.innerHTML = "";
             for(const t of allTrainsData) {
                 const stop = t.trasa.find(s => s.stanice === station);
                 if(stop) {
                     const odjel = (await get(ref(db, `odjezdy/${station}/${t.id}`))).val();
                     if(odjel) continue;
                     
                     let delay = (await get(ref(db, `zpozdeni/${station}/${t.id}`))).val() || 0;
                     
                     // Zjistit incoming delay
                     let incoming = 0;
                     if(delay == 0) {
                        for(const b of t.trasa) {
                            if(b.stanice === station) break;
                            const d = (await get(ref(db, `zpozdeni/${b.stanice}/${t.id}`))).val();
                            if(d) incoming = d;
                        }
                        delay = incoming;
                     }

                     const div = document.createElement('div');
                     div.className = 'vlak-row';
                     div.innerHTML = `
                        <div>
                            <strong>${t.nazev}</strong> (${stop.cas})
                            ${incoming > 0 ? `<span style='color:orange; font-size:0.8em;'>(veze ${incoming})</span>` : ''}
                        </div>
                        <div style="display:flex; gap:5px;">
                            <input type="number" id="d-${elId}-${t.id}" value="${delay}" style="width:50px">
                            <button class="btn-save" onclick="saveD('${station}','${t.id}','d-${elId}-${t.id}')">üíæ</button>
                            <button class="btn-gone" onclick="gone('${station}','${t.id}')">Odjel</button>
                        </div>
                     `;
                     list.appendChild(div);
                 }
             }
        }
        
        window.saveD = (s,i,inId) => set(ref(db, `zpozdeni/${s}/${i}`), document.getElementById(inId).value).then(()=>alert("Ulo≈æeno"));
        window.gone = (s,i) => set(ref(db, `odjezdy/${s}/${i}`), true);

    </script>
</body>
</html>
